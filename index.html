<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Custom Color Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #geocoder-container { position: absolute; top: 10px; left: 0; right: 0; width: 100%; padding: 0 10px; box-sizing: border-box; }
        .mapboxgl-ctrl-geocoder { width: 100%; max-width: none; }
        .map-overlay { font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif; position: absolute; width: 100%; bottom: 0; left: 0; padding: 10px; box-sizing: border-box; }
        .map-overlay .map-overlay-inner { background-color: #fff; box-shadow: none; border-radius: 3px; padding: 10px; margin-bottom: 10px; }
        .map-overlay-inner fieldset { border: none; padding: 0; margin: 0 0 10px; }
        .swatch-button { width: 64px; height: 40px; border: 2px solid transparent; cursor: pointer; border-radius: 6px; box-shadow: 0px 2px 3px -1px rgba(16, 24, 40, 0.03); margin: 4px; }
        .swatch-button.selected { border-color: #007bff; }
        .layer-container { display: inline-flex; flex-direction: column; align-items: center; margin: 8px; }
        .layer-name { font-size: 12px; color: #101828; font-weight: 500; text-align: center; margin-top: 4px; }
        #swatches { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 10px; }
        #swatches button { width: 24px; height: 24px; border: none; cursor: pointer; border-radius: 50%; }
        #color-picker { width: 100%; margin-top: 10px; display: none; }
    </style>
</head>
<body>

    <div id="map"></div>
    <div id="geocoder-container"></div>
    <div class="map-overlay top">
        <div class="map-overlay-inner">
            <fieldset>
                <label>Select layer</label>
                <div id="layer-buttons" style="display: flex; flex-wrap: wrap;"></div>
            </fieldset>
            <fieldset>
                <label>Choose a color</label>
                <div id="swatches"></div>
                <input type="color" id="color-picker">
            </fieldset>
            <button id="save-map-button">Save Map as PNG</button>
        </div>
    </div>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1Ijoia211bm96IiwiYSI6ImNsY3A3NDloaDA2bnozcGxiN2U1Y2I2bWIifQ.WY4_mVStBm5c9CjvWsVy3w';
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/kmunoz/clv912qkc00o301phcbmc6o5r',
            center: [-73.965400, 40.754651],
            zoom: 15
        });

        const geocoder = new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            mapboxgl: mapboxgl
        });

        document.getElementById('geocoder-container').appendChild(geocoder.onAdd(map));

        const layerInfo = [
            { id: 'contour', title: 'Contour' },
            { id: 'water', title: 'Water' },
            { id: 'building', title: 'Buildings' },
            { id: 'parks', title: 'Parks' },
            { id: 'road-simple', title: 'Roads' }
        ];

        const layerButtonsContainer = document.getElementById('layer-buttons');
        const colorPicker = document.getElementById('color-picker');
        let selectedLayer = null;

        function updateLayerButtonColor(layerId, color) {
            const button = document.querySelector(`.swatch-button[data-layer='${layerId}']`);
            if (button) {
                button.style.backgroundColor = color;
            }
        }

        layerInfo.forEach(layer => {
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'layer-container';

            const button = document.createElement('div');
            button.className = 'swatch-button';
            button.setAttribute('data-layer', layer.id);
            button.setAttribute('title', layer.title);

            button.addEventListener('click', () => {
                if (selectedLayer) {
                    selectedLayer.classList.remove('selected');
                }
                button.classList.add('selected');
                selectedLayer = button;

                const layerId = selectedLayer.getAttribute('data-layer');
                const layerType = map.getLayer(layerId).type;
                const paintProperty = layerType === 'line' ? 'line-color' : 'fill-color';
                const currentColor = map.getPaintProperty(layerId, paintProperty);

                colorPicker.value = rgbToHex(currentColor);
                colorPicker.style.display = 'block';
            });

            const layerName = document.createElement('div');
            layerName.className = 'layer-name';
            layerName.textContent = layer.title;

            buttonContainer.appendChild(button);
            buttonContainer.appendChild(layerName);

            layerButtonsContainer.appendChild(buttonContainer);
            updateLayerButtonColor(layer.id, '#ffffff'); // Default color until the map loads
        });

        map.on('load', function() {
            layerInfo.forEach(layer => {
                const layerType = map.getLayer(layer.id).type;
                const paintProperty = layerType === 'line' ? 'line-color' : 'fill-color';
                const currentColor = map.getPaintProperty(layer.id, paintProperty);
                updateLayerButtonColor(layer.id, currentColor);
            });

            const swatches = document.getElementById('swatches');
            const colors = [
                '#fff', '#eee', '#ddd', '#c4c4c4', '#2c2c2d', '#505050', '#767676', '#9e9e9e', '#c8c8c8',
                '#0696ab', '#5caabb', '#83becb', '#a6d2dc', '#c9e7ec', '#ebfbfd', '#afcfff', '#c3d6ff', '#cdddff', '#d8e4ff', '#e2ebff', '#41b6c4', '#2c7fb8', '#253494',
                '#06aa66', '#4bbc80', '#79cd9d', '#a0deba', '#c6eed7', '#eafef5', '#aedcbb', '#bae3c5', '#c8e8d0', '#e3f3e7', '#a1dab4', '#a6d96a', '#66bd63', '#1a9850', '#006837',
                '#ffffcc', '#ffeda0', '#fed976', '#feb24c', '#fdae61', '#fee08b', '#d9ef8b', '#fedb9c', '#feeac3',
                '#f9af0c', '#f7bf4a', '#fbcd74', '#f03b20', '#e31a1c', '#fc4e2a',
                '#9b4203', '#af6534', '#c6875f', '#daaa8c', '#edceba', '#fdf3ea', '#a77843', '#b59163', '#c6a985', '#d7c1a7', '#e8dbcb', '#f8f5ef', '#8c510a',
                '#bd0026', '#d73027', '#f46d43', '#f9b00d', '#fff9eb', '#feb24c'
            ];

            colors.forEach(color => {
                const swatch = document.createElement('button');
                swatch.style.backgroundColor = color;
                swatch.addEventListener('click', () => {
                    applyColorToLayer(color);
                    colorPicker.value = color;
                });
                swatches.appendChild(swatch);
            });

            colorPicker.addEventListener('input', (event) => {
                applyColorToLayer(event.target.value);
            });
        });

        function applyColorToLayer(color) {
            if (selectedLayer) {
                const layerId = selectedLayer.getAttribute('data-layer');
                const layerType = map.getLayer(layerId).type;
                const paintProperty = layerType === 'line' ? 'line-color' : 'fill-color';
                map.setPaintProperty(layerId, paintProperty, color);
                updateLayerButtonColor(layerId, color);
            }
        }

        function rgbToHex(rgb) {
            if (rgb.startsWith('rgba')) {
                rgb = rgb.match(/rgba?\(([^)]+)\)/)[1].split(',');
                return `#${((1 << 24) + (parseInt(rgb[0]) << 16) + (parseInt(rgb[1]) << 8) + parseInt(rgb[2])).toString(16).slice(1).toUpperCase()}`;
            } else if (rgb.startsWith('rgb')) {
                rgb = rgb.match(/rgb?\(([^)]+)\)/)[1].split(',');
                return `#${((1 << 24) + (parseInt(rgb[0]) << 16) + (parseInt(rgb[1]) << 8) + parseInt(rgb[2])).toString(16).slice(1).toUpperCase()}`;
            } else {
                return rgb;
            }
        }

        function saveMapAsPNG() {
            map.once('render', function() {
                const canvas = map.getCanvas();
                const dataURL = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = dataURL;
                link.download = 'map.png';
                link.click();
            });
            map.resize();
        }

        document.getElementById('save-map-button').addEventListener('click', saveMapAsPNG);
    </script>
</body>
</html>
